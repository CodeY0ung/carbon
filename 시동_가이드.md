# CASPIAN 시스템 시동 가이드

## 🚀 한 줄 명령어로 전체 시스템 시작

```bash
bash start-caspian.sh
```

**그게 전부입니다!** 이 명령어 하나로 모든 것이 자동으로 설정됩니다.

---

## 📋 사전 요구사항

시작하기 전에 다음이 설치되어 있어야 합니다:

### 필수 소프트웨어
- **Docker** (Docker Compose 포함)
- **Kind** (Kubernetes in Docker)
- **kubectl** (Kubernetes CLI)
- **curl**
- **bash**

### 확인 방법
```bash
docker --version          # Docker version 20.10+
docker-compose --version  # Docker Compose version 1.29+
kind --version           # kind v0.20+
kubectl version --client # kubectl v1.28+
```

---

## 🎯 완전 자동 시작 (권장)

### 1단계: 스크립트 실행 권한 부여

```bash
cd /path/to/carbon
chmod +x start-caspian.sh
chmod +x stop-caspian.sh
```

### 2단계: 시스템 시작

```bash
bash start-caspian.sh
```

### 시작 프로세스 (자동 실행)

스크립트가 다음을 자동으로 수행합니다:

```
[1/6] 기존 환경 정리
  ✓ Docker 컨테이너 종료
  ✓ 기존 Kind 클러스터 삭제 (있는 경우)

[2/6] Spoke 클러스터 생성
  ✓ carbon-kr (3 노드: 1 control-plane + 2 workers)
  ✓ carbon-jp (3 노드: 1 control-plane + 2 workers)
  ✓ carbon-cn (3 노드: 1 control-plane + 2 workers)

[3/6] Docker용 kubeconfig 생성
  ✓ kubeconfig 내보내기
  ✓ API 서버 주소를 Docker 네트워크용으로 변환

[4/6] Docker 서비스 시작
  ✓ Hub Cluster (포트 8080)
  ✓ Prometheus (포트 9090)
  ✓ Grafana (포트 3000)

[5/6] Hub API 준비 및 클러스터 등록
  ✓ Hub API 준비 대기 (최대 60초)
  ✓ carbon-kr 등록
  ✓ carbon-jp 등록
  ✓ carbon-cn 등록

[6/6] 시스템 상태 확인
  ✓ Docker 컨테이너 상태
  ✓ Kubernetes 클러스터 상태
  ✓ Hub 통계 출력
```

### 예상 소요 시간
- **최초 실행**: 약 3-5분 (Docker 이미지 빌드 포함)
- **재시작**: 약 2-3분 (이미지 캐시 사용)

---

## 🌐 시스템 접속 정보

시작이 완료되면 다음 URL로 접속할 수 있습니다:

| 서비스 | URL | 계정 | 설명 |
|--------|-----|------|------|
| **Hub API** | http://localhost:8080 | - | CASPIAN API 서버 |
| **Prometheus** | http://localhost:9090 | - | 메트릭 수집 시스템 |
| **Grafana** | http://localhost:3000 | admin/admin | 대시보드 |

### Hub API 주요 엔드포인트

```bash
# 시스템 상태
GET http://localhost:8080/hub/stats

# 클러스터 목록
GET http://localhost:8080/hub/clusters

# AppWrapper 목록
GET http://localhost:8080/hub/appwrappers

# Prometheus 메트릭
GET http://localhost:8080/metrics
```

---

## 💡 빠른 테스트

시스템이 시작되면 바로 테스트해볼 수 있습니다:

### 1. 시스템 상태 확인
```bash
curl http://localhost:8080/hub/stats | python3 -m json.tool
```

**예상 출력**:
```json
{
  "total_appwrappers": 0,
  "pending": 0,
  "running": 0,
  "completed": 0,
  "total_clusters": 3,
  "ready_clusters": 3,
  "carbon_intensity": {
    "KR": 350,
    "JP": 420,
    "CN": 580
  }
}
```

### 2. AppWrapper 제출
```bash
curl -X POST http://localhost:8080/hub/appwrappers \
  -H "Content-Type: application/json" \
  -d '{
    "job_id": "test-job",
    "cpu": 2.0,
    "mem_gb": 4.0,
    "runtime_minutes": 30,
    "deadline_minutes": 120
  }'
```

### 3. CASPIAN 스케줄링 트리거
```bash
curl -X POST http://localhost:8080/hub/schedule
```

### 4. Kubernetes Job 배포
```bash
curl -X POST http://localhost:8080/hub/dispatch
```

### 5. 배포 확인
```bash
# carbon-kr 클러스터 확인
kubectl --context kind-carbon-kr get jobs,pods

# carbon-jp 클러스터 확인
kubectl --context kind-carbon-jp get jobs,pods

# carbon-cn 클러스터 확인
kubectl --context kind-carbon-cn get jobs,pods
```

---

## 📊 Grafana 대시보드 접속

1. **브라우저에서 접속**: http://localhost:3000
2. **로그인**: admin / admin
3. **대시보드 찾기**:
   - 왼쪽 메뉴 → "Dashboards"
   - 검색: "CASPIAN"
   - "CASPIAN Carbon-Aware Scheduling" 클릭

### 대시보드 구성
- **탄소 강도 게이지** (3개): KR, JP, CN 지역별
- **탄소 강도 시계열 그래프**: 시간에 따른 변화
- **AppWrapper 통계**: Total, Pending, Running, Completed
- **클러스터 통계**: Total, Ready

---

## 🛠️ 수동 시작 (고급)

자동 스크립트를 사용하지 않고 단계별로 실행하려면:

### 1. Spoke 클러스터 생성
```bash
bash setup-spoke-clusters.sh
```

### 2. Docker kubeconfig 생성
```bash
kubectl config view --flatten > kubeconfig-docker

# API 서버 주소 변환
KR_PORT=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-carbon-kr")].cluster.server}' | grep -oP '(?<=:)\d+$')
JP_PORT=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-carbon-jp")].cluster.server}' | grep -oP '(?<=:)\d+$')
CN_PORT=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-carbon-cn")].cluster.server}' | grep -oP '(?<=:)\d+$')

sed -i "s|https://127.0.0.1:$KR_PORT|https://carbon-kr-control-plane:6443|g" kubeconfig-docker
sed -i "s|https://127.0.0.1:$JP_PORT|https://carbon-jp-control-plane:6443|g" kubeconfig-docker
sed -i "s|https://127.0.0.1:$CN_PORT|https://carbon-cn-control-plane:6443|g" kubeconfig-docker
```

### 3. Docker Compose 시작
```bash
docker-compose up -d --build
```

### 4. Hub API 대기 및 클러스터 등록
```bash
# Hub API 준비 대기
until curl -s http://localhost:8080/hub/stats > /dev/null; do
  echo "Waiting for Hub API..."
  sleep 2
done

# 클러스터 등록
curl -X POST http://localhost:8080/hub/clusters \
  -H "Content-Type: application/json" \
  -d '{
    "name": "carbon-kr",
    "geolocation": "KR",
    "carbon_intensity": 400.0,
    "resources": {
      "cpu_available": 14.0,
      "cpu_total": 16.0,
      "mem_available_gb": 28.0,
      "mem_total_gb": 32.0
    },
    "kubeconfig_context": "kind-carbon-kr"
  }'

# carbon-jp, carbon-cn 동일하게 등록...
```

---

## 🔄 시스템 종료

### 완전 종료 (권장)
```bash
bash stop-caspian.sh
```

스크립트가 물어봅니다:
- Docker 컨테이너 종료 (자동)
- Kind 클러스터 삭제 여부 (선택)

### Docker만 종료 (클러스터 유지)
```bash
docker-compose down
```

### 전체 삭제 (완전 초기화)
```bash
# Docker 종료
docker-compose down

# Kind 클러스터 삭제
kind delete cluster --name carbon-kr
kind delete cluster --name carbon-jp
kind delete cluster --name carbon-cn

# Docker 이미지 삭제 (선택)
docker rmi carbon-hub
```

---

## 🔧 트러블슈팅

### 문제 1: "Hub API 시작 시간 초과"

**원인**: Hub 컨테이너가 시작되지 않음

**해결**:
```bash
# 로그 확인
docker logs carbon-hub

# 컨테이너 재시작
docker-compose restart hub

# 또는 완전 재빌드
docker-compose up -d --build --force-recreate hub
```

### 문제 2: "클러스터 등록 실패"

**원인**: kubeconfig 설정 오류

**해결**:
```bash
# kubeconfig 재생성
kubectl config view --flatten > kubeconfig-docker

# API 주소 확인
grep "server:" kubeconfig-docker

# 주소가 carbon-*-control-plane:6443 형태인지 확인
```

### 문제 3: "Kubernetes Job 배포 실패"

**원인**: Hub가 Kind 클러스터에 접근 불가

**해결**:
```bash
# Docker 네트워크 확인
docker network ls | grep kind

# Hub 컨테이너가 kind 네트워크에 연결되었는지 확인
docker inspect carbon-hub | grep Networks

# 필요시 docker-compose.yml에서 networks 섹션 확인
```

### 문제 4: "Grafana 대시보드가 보이지 않음"

**해결**:
```bash
# Grafana 재시작
docker-compose restart grafana

# 대시보드 파일 확인
ls -la dashboards/carbon-hub-dashboard.json

# 프로비저닝 설정 확인
cat grafana/provisioning/dashboards/dashboard.yml
```

---

## 📝 로그 확인

### Hub 로그
```bash
docker logs -f carbon-hub
```

### Prometheus 로그
```bash
docker logs -f carbon-prometheus
```

### Grafana 로그
```bash
docker logs -f carbon-grafana
```

### 모든 컨테이너 로그
```bash
docker-compose logs -f
```

---

## 🎯 자동 실행 주기

시스템이 시작되면 다음이 자동으로 실행됩니다:

| 작업 | 주기 | 설명 |
|------|------|------|
| **Carbon Client** | 10초 | 탄소 강도 데이터 업데이트 |
| **Hub Scheduler** | 5분 | CASPIAN 스케줄링 실행 |
| **Hub Dispatcher** | 30초 | Kubernetes Job 배포 |
| **Prometheus Scrape** | 10초 | 메트릭 수집 |
| **Grafana Refresh** | 5초 | 대시보드 갱신 |

### 수동 트리거

자동 실행을 기다리지 않고 즉시 실행:

```bash
# 스케줄링 즉시 실행
curl -X POST http://localhost:8080/hub/schedule

# 디스패치 즉시 실행
curl -X POST http://localhost:8080/hub/dispatch
```

---

## 📚 추가 문서

- **[시스템_완료_보고서.md](시스템_완료_보고서.md)**: 전체 시스템 현황
- **[HUB_SPOKE_구현_가이드.md](HUB_SPOKE_구현_가이드.md)**: 구현 상세
- **[CASPIAN_알고리즘_설명.md](CASPIAN_알고리즘_설명.md)**: 알고리즘 설명
- **[README_시작가이드.md](README_시작가이드.md)**: 기본 가이드

---

## ✅ 빠른 체크리스트

시작 후 확인:

- [ ] Docker 컨테이너 3개 실행 중 (hub, prometheus, grafana)
- [ ] Kind 클러스터 3개 Ready (carbon-kr, carbon-jp, carbon-cn)
- [ ] Hub API 응답 확인 (http://localhost:8080/hub/stats)
- [ ] Prometheus 메트릭 수집 확인 (http://localhost:9090)
- [ ] Grafana 대시보드 접속 확인 (http://localhost:3000)
- [ ] Hub에 클러스터 3개 등록 확인
- [ ] 테스트 Job 제출 및 배포 확인

---

## 🎉 다음 단계

시스템이 정상 작동하면:

1. **실제 워크로드 테스트**: 다양한 CPU/메모리 요구사항으로 Job 제출
2. **탄소 강도 변화 관찰**: Grafana에서 실시간 변화 확인
3. **스케줄링 결과 분석**: 어느 클러스터가 선택되는지 확인
4. **실제 API 연동**: `USE_MOCK_DATA=false`로 설정하여 ElectricityMap API 사용

---

**시작 명령어 다시 한 번**:
```bash
bash start-caspian.sh
```

**끝! 🚀**
