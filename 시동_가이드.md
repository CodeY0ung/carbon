# CASPIAN ì‹œìŠ¤í…œ ì‹œë™ ê°€ì´ë“œ

## ğŸš€ í•œ ì¤„ ëª…ë ¹ì–´ë¡œ ì „ì²´ ì‹œìŠ¤í…œ ì‹œì‘

```bash
bash start-caspian.sh
```

**ê·¸ê²Œ ì „ë¶€ì…ë‹ˆë‹¤!** ì´ ëª…ë ¹ì–´ í•˜ë‚˜ë¡œ ëª¨ë“  ê²ƒì´ ìë™ìœ¼ë¡œ ì„¤ì •ë©ë‹ˆë‹¤.

---

## ğŸ“‹ ì‚¬ì „ ìš”êµ¬ì‚¬í•­

ì‹œì‘í•˜ê¸° ì „ì— ë‹¤ìŒì´ ì„¤ì¹˜ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤:

### í•„ìˆ˜ ì†Œí”„íŠ¸ì›¨ì–´
- **Docker** (Docker Compose í¬í•¨)
- **Kind** (Kubernetes in Docker)
- **kubectl** (Kubernetes CLI)
- **curl**
- **bash**

### í™•ì¸ ë°©ë²•
```bash
docker --version          # Docker version 20.10+
docker-compose --version  # Docker Compose version 1.29+
kind --version           # kind v0.20+
kubectl version --client # kubectl v1.28+
```

---

## ğŸ¯ ì™„ì „ ìë™ ì‹œì‘ (ê¶Œì¥)

### 1ë‹¨ê³„: ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰ ê¶Œí•œ ë¶€ì—¬

```bash
cd /path/to/carbon
chmod +x start-caspian.sh
chmod +x stop-caspian.sh
```

### 2ë‹¨ê³„: ì‹œìŠ¤í…œ ì‹œì‘

```bash
bash start-caspian.sh
```

### ì‹œì‘ í”„ë¡œì„¸ìŠ¤ (ìë™ ì‹¤í–‰)

ìŠ¤í¬ë¦½íŠ¸ê°€ ë‹¤ìŒì„ ìë™ìœ¼ë¡œ ìˆ˜í–‰í•©ë‹ˆë‹¤:

```
[1/6] ê¸°ì¡´ í™˜ê²½ ì •ë¦¬
  âœ“ Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
  âœ“ ê¸°ì¡´ Kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ (ìˆëŠ” ê²½ìš°)

[2/6] Spoke í´ëŸ¬ìŠ¤í„° ìƒì„±
  âœ“ carbon-kr (3 ë…¸ë“œ: 1 control-plane + 2 workers)
  âœ“ carbon-jp (3 ë…¸ë“œ: 1 control-plane + 2 workers)
  âœ“ carbon-cn (3 ë…¸ë“œ: 1 control-plane + 2 workers)

[3/6] Dockerìš© kubeconfig ìƒì„±
  âœ“ kubeconfig ë‚´ë³´ë‚´ê¸°
  âœ“ API ì„œë²„ ì£¼ì†Œë¥¼ Docker ë„¤íŠ¸ì›Œí¬ìš©ìœ¼ë¡œ ë³€í™˜

[4/6] Docker ì„œë¹„ìŠ¤ ì‹œì‘
  âœ“ Hub Cluster (í¬íŠ¸ 8080)
  âœ“ Prometheus (í¬íŠ¸ 9090)
  âœ“ Grafana (í¬íŠ¸ 3000)

[5/6] Hub API ì¤€ë¹„ ë° í´ëŸ¬ìŠ¤í„° ë“±ë¡
  âœ“ Hub API ì¤€ë¹„ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
  âœ“ carbon-kr ë“±ë¡
  âœ“ carbon-jp ë“±ë¡
  âœ“ carbon-cn ë“±ë¡

[6/6] ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
  âœ“ Docker ì»¨í…Œì´ë„ˆ ìƒíƒœ
  âœ“ Kubernetes í´ëŸ¬ìŠ¤í„° ìƒíƒœ
  âœ“ Hub í†µê³„ ì¶œë ¥
```

### ì˜ˆìƒ ì†Œìš” ì‹œê°„
- **ìµœì´ˆ ì‹¤í–‰**: ì•½ 3-5ë¶„ (Docker ì´ë¯¸ì§€ ë¹Œë“œ í¬í•¨)
- **ì¬ì‹œì‘**: ì•½ 2-3ë¶„ (ì´ë¯¸ì§€ ìºì‹œ ì‚¬ìš©)

---

## ğŸŒ ì‹œìŠ¤í…œ ì ‘ì† ì •ë³´

ì‹œì‘ì´ ì™„ë£Œë˜ë©´ ë‹¤ìŒ URLë¡œ ì ‘ì†í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

| ì„œë¹„ìŠ¤ | URL | ê³„ì • | ì„¤ëª… |
|--------|-----|------|------|
| **Hub API** | http://localhost:8080 | - | CASPIAN API ì„œë²„ |
| **Prometheus** | http://localhost:9090 | - | ë©”íŠ¸ë¦­ ìˆ˜ì§‘ ì‹œìŠ¤í…œ |
| **Grafana** | http://localhost:3000 | admin/admin | ëŒ€ì‹œë³´ë“œ |

### Hub API ì£¼ìš” ì—”ë“œí¬ì¸íŠ¸

```bash
# ì‹œìŠ¤í…œ ìƒíƒœ
GET http://localhost:8080/hub/stats

# í´ëŸ¬ìŠ¤í„° ëª©ë¡
GET http://localhost:8080/hub/clusters

# AppWrapper ëª©ë¡
GET http://localhost:8080/hub/appwrappers

# Prometheus ë©”íŠ¸ë¦­
GET http://localhost:8080/metrics
```

---

## ğŸ’¡ ë¹ ë¥¸ í…ŒìŠ¤íŠ¸

ì‹œìŠ¤í…œì´ ì‹œì‘ë˜ë©´ ë°”ë¡œ í…ŒìŠ¤íŠ¸í•´ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤:

### 1. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸
```bash
curl http://localhost:8080/hub/stats | python3 -m json.tool
```

**ì˜ˆìƒ ì¶œë ¥**:
```json
{
  "total_appwrappers": 0,
  "pending": 0,
  "running": 0,
  "completed": 0,
  "total_clusters": 3,
  "ready_clusters": 3,
  "carbon_intensity": {
    "KR": 350,
    "JP": 420,
    "CN": 580
  }
}
```

### 2. AppWrapper ì œì¶œ
```bash
curl -X POST http://localhost:8080/hub/appwrappers \
  -H "Content-Type: application/json" \
  -d '{
    "job_id": "test-job",
    "cpu": 2.0,
    "mem_gb": 4.0,
    "runtime_minutes": 30,
    "deadline_minutes": 120
  }'
```

### 3. CASPIAN ìŠ¤ì¼€ì¤„ë§ íŠ¸ë¦¬ê±°
```bash
curl -X POST http://localhost:8080/hub/schedule
```

### 4. Kubernetes Job ë°°í¬
```bash
curl -X POST http://localhost:8080/hub/dispatch
```

### 5. ë°°í¬ í™•ì¸
```bash
# carbon-kr í´ëŸ¬ìŠ¤í„° í™•ì¸
kubectl --context kind-carbon-kr get jobs,pods

# carbon-jp í´ëŸ¬ìŠ¤í„° í™•ì¸
kubectl --context kind-carbon-jp get jobs,pods

# carbon-cn í´ëŸ¬ìŠ¤í„° í™•ì¸
kubectl --context kind-carbon-cn get jobs,pods
```

---

## ğŸ“Š Grafana ëŒ€ì‹œë³´ë“œ ì ‘ì†

1. **ë¸Œë¼ìš°ì €ì—ì„œ ì ‘ì†**: http://localhost:3000
2. **ë¡œê·¸ì¸**: admin / admin
3. **ëŒ€ì‹œë³´ë“œ ì°¾ê¸°**:
   - ì™¼ìª½ ë©”ë‰´ â†’ "Dashboards"
   - ê²€ìƒ‰: "CASPIAN"
   - "CASPIAN Carbon-Aware Scheduling" í´ë¦­

### ëŒ€ì‹œë³´ë“œ êµ¬ì„±
- **íƒ„ì†Œ ê°•ë„ ê²Œì´ì§€** (3ê°œ): KR, JP, CN ì§€ì—­ë³„
- **íƒ„ì†Œ ê°•ë„ ì‹œê³„ì—´ ê·¸ë˜í”„**: ì‹œê°„ì— ë”°ë¥¸ ë³€í™”
- **AppWrapper í†µê³„**: Total, Pending, Running, Completed
- **í´ëŸ¬ìŠ¤í„° í†µê³„**: Total, Ready

---

## ğŸ› ï¸ ìˆ˜ë™ ì‹œì‘ (ê³ ê¸‰)

ìë™ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ë‹¨ê³„ë³„ë¡œ ì‹¤í–‰í•˜ë ¤ë©´:

### 1. Spoke í´ëŸ¬ìŠ¤í„° ìƒì„±
```bash
bash setup-spoke-clusters.sh
```

### 2. Docker kubeconfig ìƒì„±
```bash
kubectl config view --flatten > kubeconfig-docker

# API ì„œë²„ ì£¼ì†Œ ë³€í™˜
KR_PORT=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-carbon-kr")].cluster.server}' | grep -oP '(?<=:)\d+$')
JP_PORT=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-carbon-jp")].cluster.server}' | grep -oP '(?<=:)\d+$')
CN_PORT=$(kubectl config view -o jsonpath='{.clusters[?(@.name=="kind-carbon-cn")].cluster.server}' | grep -oP '(?<=:)\d+$')

sed -i "s|https://127.0.0.1:$KR_PORT|https://carbon-kr-control-plane:6443|g" kubeconfig-docker
sed -i "s|https://127.0.0.1:$JP_PORT|https://carbon-jp-control-plane:6443|g" kubeconfig-docker
sed -i "s|https://127.0.0.1:$CN_PORT|https://carbon-cn-control-plane:6443|g" kubeconfig-docker
```

### 3. Docker Compose ì‹œì‘
```bash
docker-compose up -d --build
```

### 4. Hub API ëŒ€ê¸° ë° í´ëŸ¬ìŠ¤í„° ë“±ë¡
```bash
# Hub API ì¤€ë¹„ ëŒ€ê¸°
until curl -s http://localhost:8080/hub/stats > /dev/null; do
  echo "Waiting for Hub API..."
  sleep 2
done

# í´ëŸ¬ìŠ¤í„° ë“±ë¡
curl -X POST http://localhost:8080/hub/clusters \
  -H "Content-Type: application/json" \
  -d '{
    "name": "carbon-kr",
    "geolocation": "KR",
    "carbon_intensity": 400.0,
    "resources": {
      "cpu_available": 14.0,
      "cpu_total": 16.0,
      "mem_available_gb": 28.0,
      "mem_total_gb": 32.0
    },
    "kubeconfig_context": "kind-carbon-kr"
  }'

# carbon-jp, carbon-cn ë™ì¼í•˜ê²Œ ë“±ë¡...
```

---

## ğŸ”„ ì‹œìŠ¤í…œ ì¢…ë£Œ

### ì™„ì „ ì¢…ë£Œ (ê¶Œì¥)
```bash
bash stop-caspian.sh
```

ìŠ¤í¬ë¦½íŠ¸ê°€ ë¬¼ì–´ë´…ë‹ˆë‹¤:
- Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œ (ìë™)
- Kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ ì—¬ë¶€ (ì„ íƒ)

### Dockerë§Œ ì¢…ë£Œ (í´ëŸ¬ìŠ¤í„° ìœ ì§€)
```bash
docker-compose down
```

### ì „ì²´ ì‚­ì œ (ì™„ì „ ì´ˆê¸°í™”)
```bash
# Docker ì¢…ë£Œ
docker-compose down

# Kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ
kind delete cluster --name carbon-kr
kind delete cluster --name carbon-jp
kind delete cluster --name carbon-cn

# Docker ì´ë¯¸ì§€ ì‚­ì œ (ì„ íƒ)
docker rmi carbon-hub
```

---

## ğŸ”§ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### ë¬¸ì œ 1: "Hub API ì‹œì‘ ì‹œê°„ ì´ˆê³¼"

**ì›ì¸**: Hub ì»¨í…Œì´ë„ˆê°€ ì‹œì‘ë˜ì§€ ì•ŠìŒ

**í•´ê²°**:
```bash
# ë¡œê·¸ í™•ì¸
docker logs carbon-hub

# ì»¨í…Œì´ë„ˆ ì¬ì‹œì‘
docker-compose restart hub

# ë˜ëŠ” ì™„ì „ ì¬ë¹Œë“œ
docker-compose up -d --build --force-recreate hub
```

### ë¬¸ì œ 2: "í´ëŸ¬ìŠ¤í„° ë“±ë¡ ì‹¤íŒ¨"

**ì›ì¸**: kubeconfig ì„¤ì • ì˜¤ë¥˜

**í•´ê²°**:
```bash
# kubeconfig ì¬ìƒì„±
kubectl config view --flatten > kubeconfig-docker

# API ì£¼ì†Œ í™•ì¸
grep "server:" kubeconfig-docker

# ì£¼ì†Œê°€ carbon-*-control-plane:6443 í˜•íƒœì¸ì§€ í™•ì¸
```

### ë¬¸ì œ 3: "Kubernetes Job ë°°í¬ ì‹¤íŒ¨"

**ì›ì¸**: Hubê°€ Kind í´ëŸ¬ìŠ¤í„°ì— ì ‘ê·¼ ë¶ˆê°€

**í•´ê²°**:
```bash
# Docker ë„¤íŠ¸ì›Œí¬ í™•ì¸
docker network ls | grep kind

# Hub ì»¨í…Œì´ë„ˆê°€ kind ë„¤íŠ¸ì›Œí¬ì— ì—°ê²°ë˜ì—ˆëŠ”ì§€ í™•ì¸
docker inspect carbon-hub | grep Networks

# í•„ìš”ì‹œ docker-compose.ymlì—ì„œ networks ì„¹ì…˜ í™•ì¸
```

### ë¬¸ì œ 4: "Grafana ëŒ€ì‹œë³´ë“œê°€ ë³´ì´ì§€ ì•ŠìŒ"

**í•´ê²°**:
```bash
# Grafana ì¬ì‹œì‘
docker-compose restart grafana

# ëŒ€ì‹œë³´ë“œ íŒŒì¼ í™•ì¸
ls -la dashboards/carbon-hub-dashboard.json

# í”„ë¡œë¹„ì €ë‹ ì„¤ì • í™•ì¸
cat grafana/provisioning/dashboards/dashboard.yml
```

---

## ğŸ“ ë¡œê·¸ í™•ì¸

### Hub ë¡œê·¸
```bash
docker logs -f carbon-hub
```

### Prometheus ë¡œê·¸
```bash
docker logs -f carbon-prometheus
```

### Grafana ë¡œê·¸
```bash
docker logs -f carbon-grafana
```

### ëª¨ë“  ì»¨í…Œì´ë„ˆ ë¡œê·¸
```bash
docker-compose logs -f
```

---

## ğŸ¯ ìë™ ì‹¤í–‰ ì£¼ê¸°

ì‹œìŠ¤í…œì´ ì‹œì‘ë˜ë©´ ë‹¤ìŒì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤:

| ì‘ì—… | ì£¼ê¸° | ì„¤ëª… |
|------|------|------|
| **Carbon Client** | 10ì´ˆ | íƒ„ì†Œ ê°•ë„ ë°ì´í„° ì—…ë°ì´íŠ¸ |
| **Hub Scheduler** | 5ë¶„ | CASPIAN ìŠ¤ì¼€ì¤„ë§ ì‹¤í–‰ |
| **Hub Dispatcher** | 30ì´ˆ | Kubernetes Job ë°°í¬ |
| **Prometheus Scrape** | 10ì´ˆ | ë©”íŠ¸ë¦­ ìˆ˜ì§‘ |
| **Grafana Refresh** | 5ì´ˆ | ëŒ€ì‹œë³´ë“œ ê°±ì‹  |

### ìˆ˜ë™ íŠ¸ë¦¬ê±°

ìë™ ì‹¤í–‰ì„ ê¸°ë‹¤ë¦¬ì§€ ì•Šê³  ì¦‰ì‹œ ì‹¤í–‰:

```bash
# ìŠ¤ì¼€ì¤„ë§ ì¦‰ì‹œ ì‹¤í–‰
curl -X POST http://localhost:8080/hub/schedule

# ë””ìŠ¤íŒ¨ì¹˜ ì¦‰ì‹œ ì‹¤í–‰
curl -X POST http://localhost:8080/hub/dispatch
```

---

## ğŸ“š ì¶”ê°€ ë¬¸ì„œ

- **[ì‹œìŠ¤í…œ_ì™„ë£Œ_ë³´ê³ ì„œ.md](ì‹œìŠ¤í…œ_ì™„ë£Œ_ë³´ê³ ì„œ.md)**: ì „ì²´ ì‹œìŠ¤í…œ í˜„í™©
- **[HUB_SPOKE_êµ¬í˜„_ê°€ì´ë“œ.md](HUB_SPOKE_êµ¬í˜„_ê°€ì´ë“œ.md)**: êµ¬í˜„ ìƒì„¸
- **[CASPIAN_ì•Œê³ ë¦¬ì¦˜_ì„¤ëª….md](CASPIAN_ì•Œê³ ë¦¬ì¦˜_ì„¤ëª….md)**: ì•Œê³ ë¦¬ì¦˜ ì„¤ëª…
- **[README_ì‹œì‘ê°€ì´ë“œ.md](README_ì‹œì‘ê°€ì´ë“œ.md)**: ê¸°ë³¸ ê°€ì´ë“œ

---

## âœ… ë¹ ë¥¸ ì²´í¬ë¦¬ìŠ¤íŠ¸

ì‹œì‘ í›„ í™•ì¸:

- [ ] Docker ì»¨í…Œì´ë„ˆ 3ê°œ ì‹¤í–‰ ì¤‘ (hub, prometheus, grafana)
- [ ] Kind í´ëŸ¬ìŠ¤í„° 3ê°œ Ready (carbon-kr, carbon-jp, carbon-cn)
- [ ] Hub API ì‘ë‹µ í™•ì¸ (http://localhost:8080/hub/stats)
- [ ] Prometheus ë©”íŠ¸ë¦­ ìˆ˜ì§‘ í™•ì¸ (http://localhost:9090)
- [ ] Grafana ëŒ€ì‹œë³´ë“œ ì ‘ì† í™•ì¸ (http://localhost:3000)
- [ ] Hubì— í´ëŸ¬ìŠ¤í„° 3ê°œ ë“±ë¡ í™•ì¸
- [ ] í…ŒìŠ¤íŠ¸ Job ì œì¶œ ë° ë°°í¬ í™•ì¸

---

## ğŸ‰ ë‹¤ìŒ ë‹¨ê³„

ì‹œìŠ¤í…œì´ ì •ìƒ ì‘ë™í•˜ë©´:

1. **ì‹¤ì œ ì›Œí¬ë¡œë“œ í…ŒìŠ¤íŠ¸**: ë‹¤ì–‘í•œ CPU/ë©”ëª¨ë¦¬ ìš”êµ¬ì‚¬í•­ìœ¼ë¡œ Job ì œì¶œ
2. **íƒ„ì†Œ ê°•ë„ ë³€í™” ê´€ì°°**: Grafanaì—ì„œ ì‹¤ì‹œê°„ ë³€í™” í™•ì¸
3. **ìŠ¤ì¼€ì¤„ë§ ê²°ê³¼ ë¶„ì„**: ì–´ëŠ í´ëŸ¬ìŠ¤í„°ê°€ ì„ íƒë˜ëŠ”ì§€ í™•ì¸
4. **ì‹¤ì œ API ì—°ë™**: `USE_MOCK_DATA=false`ë¡œ ì„¤ì •í•˜ì—¬ ElectricityMap API ì‚¬ìš©

---

**ì‹œì‘ ëª…ë ¹ì–´ ë‹¤ì‹œ í•œ ë²ˆ**:
```bash
bash start-caspian.sh
```

**ë! ğŸš€**
