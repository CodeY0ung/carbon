# CASPIAN í”„ë¡œì íŠ¸ êµ¬ì¡° ë° íŒŒì¼ ì—­í• 

## ğŸ“ ì „ì²´ ë””ë ‰í† ë¦¬ êµ¬ì¡°

```
carbon/
â”‚
â”œâ”€â”€ ğŸ“‚ hub/                        # Hub Cluster êµ¬í˜„ (í•µì‹¬)
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ app.py                    # Hub API ì„œë²„
â”‚   â”œâ”€â”€ models.py                 # ë°ì´í„° ëª¨ë¸
â”‚   â”œâ”€â”€ store.py                  # ë°ì´í„° ì €ì¥ì†Œ
â”‚   â”œâ”€â”€ scheduler.py              # CASPIAN ìŠ¤ì¼€ì¤„ëŸ¬
â”‚   â””â”€â”€ dispatcher.py             # Kubernetes ë””ìŠ¤íŒ¨ì²˜
â”‚
â”œâ”€â”€ ğŸ“‚ app/                        # ê³µìœ  ì»´í¬ë„ŒíŠ¸
â”‚   â”œâ”€â”€ __init__.py
â”‚   â”œâ”€â”€ optimizer.py              # CASPIAN MILP ìµœì í™”
â”‚   â”œâ”€â”€ schemas.py                # Pydantic ìŠ¤í‚¤ë§ˆ
â”‚   â”œâ”€â”€ carbon_client.py          # íƒ„ì†Œ ë°ì´í„° ìˆ˜ì§‘
â”‚   â”œâ”€â”€ metrics.py                # Prometheus ë©”íŠ¸ë¦­
â”‚   â”œâ”€â”€ requirements.txt          # Python ì˜ì¡´ì„±
â”‚   â””â”€â”€ tests/                    # í…ŒìŠ¤íŠ¸
â”‚       â”œâ”€â”€ __init__.py
â”‚       â”œâ”€â”€ test_carbon_client.py
â”‚       â””â”€â”€ test_main.py
â”‚
â”œâ”€â”€ ğŸ“‚ clusters/                   # Kind í´ëŸ¬ìŠ¤í„° ì„¤ì •
â”‚   â”œâ”€â”€ cluster-kr.yaml           # í•œêµ­ í´ëŸ¬ìŠ¤í„° ì„¤ì •
â”‚   â”œâ”€â”€ cluster-jp.yaml           # ì¼ë³¸ í´ëŸ¬ìŠ¤í„° ì„¤ì •
â”‚   â””â”€â”€ cluster-cn.yaml           # ì¤‘êµ­ í´ëŸ¬ìŠ¤í„° ì„¤ì •
â”‚
â”œâ”€â”€ ğŸ“‚ dashboards/                 # Grafana ëŒ€ì‹œë³´ë“œ
â”‚   â”œâ”€â”€ carbon_dashboard.json     # ë ˆê±°ì‹œ ëŒ€ì‹œë³´ë“œ
â”‚   â””â”€â”€ carbon-hub-dashboard.json # Hub ëŒ€ì‹œë³´ë“œ (í˜„ì¬ ì‚¬ìš©)
â”‚
â”œâ”€â”€ ğŸ“‚ grafana/                    # Grafana í”„ë¡œë¹„ì €ë‹
â”‚   â””â”€â”€ provisioning/
â”‚       â”œâ”€â”€ datasources/
â”‚       â”‚   â””â”€â”€ prometheus.yml    # Prometheus ë°ì´í„°ì†ŒìŠ¤
â”‚       â””â”€â”€ dashboards/
â”‚           â””â”€â”€ dashboard.yml     # ëŒ€ì‹œë³´ë“œ í”„ë¡œë¹„ì €ë‹ ì„¤ì •
â”‚
â”œâ”€â”€ ğŸ“‚ k8s/                        # Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸
â”‚   â”œâ”€â”€ deployment.yaml           # ì•± ë°°í¬
â”‚   â”œâ”€â”€ operator-deployment.yaml  # Operator ë°°í¬
â”‚   â”œâ”€â”€ operator-rbac.yaml        # Operator RBAC
â”‚   â”œâ”€â”€ prometheus-scrape.yaml    # Prometheus ServiceMonitor
â”‚   â””â”€â”€ all-in-one.yaml           # í†µí•© ë°°í¬
â”‚
â”œâ”€â”€ ğŸ“‚ operator/                   # Kubernetes Operator (ë¯¸ì‚¬ìš©)
â”‚   â”œâ”€â”€ Dockerfile
â”‚   â”œâ”€â”€ operator.py
â”‚   â””â”€â”€ tests/
â”‚       â”œâ”€â”€ __init__.py
â”‚       â””â”€â”€ test_operator.py
â”‚
â”œâ”€â”€ ğŸ“‚ .claude/                    # Claude Code ì„¤ì •
â”‚   â””â”€â”€ settings.local.json
â”‚
â”œâ”€â”€ ğŸš€ start-caspian.sh           # ì™„ì „ ìë™ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ (Linux/Mac)
â”œâ”€â”€ ğŸš€ start-caspian.bat          # ì™„ì „ ìë™ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ (Windows)
â”œâ”€â”€ ğŸ›‘ stop-caspian.sh            # ì‹œìŠ¤í…œ ì¢…ë£Œ ìŠ¤í¬ë¦½íŠ¸
â”œâ”€â”€ âš™ï¸ setup-spoke-clusters.sh    # Spoke í´ëŸ¬ìŠ¤í„° ìƒì„±
â”‚
â”œâ”€â”€ ğŸ³ docker-compose.yml         # Docker Compose ì„¤ì •
â”œâ”€â”€ ğŸ³ Dockerfile                 # Hub ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€
â”œâ”€â”€ ğŸ“Š prometheus.yml             # Prometheus ì„¤ì •
â”œâ”€â”€ ğŸ”§ kubeconfig-docker          # Dockerìš© kubeconfig (ìƒì„±ë¨)
â”‚
â”œâ”€â”€ ğŸ“– README.md                  # ë©”ì¸ ë¬¸ì„œ
â”œâ”€â”€ ğŸ“– QUICKSTART.md              # ë¹ ë¥¸ ì‹œì‘ ê°€ì´ë“œ
â”œâ”€â”€ ğŸ“– ì‹œë™_ê°€ì´ë“œ.md             # ìƒì„¸ ì‹œë™ ê°€ì´ë“œ
â”œâ”€â”€ ğŸ“– ì‹œìŠ¤í…œ_ì™„ë£Œ_ë³´ê³ ì„œ.md      # ì‹œìŠ¤í…œ í˜„í™© ë³´ê³ ì„œ
â”œâ”€â”€ ğŸ“– HUB_SPOKE_êµ¬í˜„_ê°€ì´ë“œ.md   # Hub-Spoke êµ¬í˜„ ê°€ì´ë“œ
â”œâ”€â”€ ğŸ“– CASPIAN_ì•Œê³ ë¦¬ì¦˜_ì„¤ëª….md   # ì•Œê³ ë¦¬ì¦˜ ì„¤ëª…
â”œâ”€â”€ ğŸ“– í”„ë¡œì íŠ¸_íŒŒì¼_êµ¬ì¡°.md      # íŒŒì¼ êµ¬ì¡° (ë ˆê±°ì‹œ)
â”œâ”€â”€ ğŸ“– CASPIAN_ìµœì í™”_ì´ìœ .md     # ìµœì í™” ì´ìœ  ì„¤ëª…
â”œâ”€â”€ ğŸ“– ë§ˆì´ê·¸ë ˆì´ì…˜_ê°€ì´ë“œ.md     # ë§ˆì´ê·¸ë ˆì´ì…˜ ê°€ì´ë“œ
â”œâ”€â”€ ğŸ“– scheduling_sample.md       # ì›ë³¸ ìŠ¤ì¼€ì¤„ë§ ìƒ˜í”Œ
â”‚
â”œâ”€â”€ ğŸ§ª test_caspian.py            # í†µí•© í…ŒìŠ¤íŠ¸
â”œâ”€â”€ ğŸ§ª test-job-kr.yaml           # í…ŒìŠ¤íŠ¸ Job (KR)
â”œâ”€â”€ ğŸ§ª test-job-jp.yaml           # í…ŒìŠ¤íŠ¸ Job (JP)
â”œâ”€â”€ ğŸ§ª test-job-cn.yaml           # í…ŒìŠ¤íŠ¸ Job (CN)
â”‚
â”œâ”€â”€ ğŸ“œ dev-run.sh                 # ê°œë°œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ë ˆê±°ì‹œ)
â”œâ”€â”€ ğŸ“œ run_local.sh               # ë¡œì»¬ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ë ˆê±°ì‹œ)
â”œâ”€â”€ ğŸ“œ start-hub-spoke.sh         # Hub-Spoke ì‹œì‘ (ë ˆê±°ì‹œ)
â””â”€â”€ ğŸ“œ start-system.bat           # ì‹œìŠ¤í…œ ì‹œì‘ (ë ˆê±°ì‹œ)
```

---

## ğŸ¯ í•µì‹¬ ë””ë ‰í† ë¦¬ ìƒì„¸ ì„¤ëª…

### ğŸ“‚ `hub/` - Hub Cluster êµ¬í˜„ (ê°€ì¥ ì¤‘ìš”)

Hub-Spoke ì•„í‚¤í…ì²˜ì˜ ì¤‘ì•™ í—ˆë¸Œ í´ëŸ¬ìŠ¤í„° êµ¬í˜„

#### `hub/app.py` (485ì¤„)
**ì—­í• **: Hub Clusterì˜ FastAPI ì„œë²„
**í¬íŠ¸**: 8080
**ì£¼ìš” ê¸°ëŠ¥**:
- ClusterInfo ê´€ë¦¬ API (`/hub/clusters`)
- AppWrapper ê´€ë¦¬ API (`/hub/appwrappers`)
- ìˆ˜ë™ ìŠ¤ì¼€ì¤„ë§/ë””ìŠ¤íŒ¨ì¹˜ íŠ¸ë¦¬ê±° (`/hub/schedule`, `/hub/dispatch`)
- ì‹œìŠ¤í…œ í†µê³„ (`/hub/stats`)
- Prometheus ë©”íŠ¸ë¦­ ë…¸ì¶œ (`/metrics`)
- Carbon Client í†µí•© (íƒ„ì†Œ ê°•ë„ ìë™ ì—…ë°ì´íŠ¸)

**í•µì‹¬ ì—”ë“œí¬ì¸íŠ¸**:
```python
POST   /hub/clusters        # Spoke í´ëŸ¬ìŠ¤í„° ë“±ë¡
GET    /hub/clusters        # í´ëŸ¬ìŠ¤í„° ëª©ë¡
POST   /hub/appwrappers     # AppWrapper ì œì¶œ
GET    /hub/appwrappers     # AppWrapper ëª©ë¡
POST   /hub/schedule        # ìŠ¤ì¼€ì¤„ë§ íŠ¸ë¦¬ê±°
POST   /hub/dispatch        # ë””ìŠ¤íŒ¨ì¹˜ íŠ¸ë¦¬ê±°
GET    /hub/stats           # ì‹œìŠ¤í…œ í†µê³„
GET    /metrics             # Prometheus ë©”íŠ¸ë¦­
```

#### `hub/models.py` (150ì¤„)
**ì—­í• **: Hub ë°ì´í„° ëª¨ë¸ ì •ì˜
**ì£¼ìš” ëª¨ë¸**:
- `ClusterInfo`: Spoke í´ëŸ¬ìŠ¤í„° ì •ë³´ (geolocation, carbon_intensity, resources)
- `ClusterResources`: í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ (CPU, ë©”ëª¨ë¦¬, GPU)
- `AppWrapper`: Job ë˜í¼ (spec + status)
- `AppWrapperSpec`: Job ëª…ì„¸ (target_cluster, dispatching_gates)
- `AppWrapperStatus`: Job ìƒíƒœ (phase, dispatched, cluster)
- `DispatchingGate`: ë°°í¬ ê²Œì´íŠ¸ (sustainability-gate)
- `GateStatus`: ê²Œì´íŠ¸ ìƒíƒœ (OPEN/CLOSED)

**ë°ì´í„° íë¦„**:
```
AppWrapperSpec â†’ HubScheduler â†’ targetCluster ê²°ì • â†’ gate OPEN
                                                    â†“
                                            HubDispatcher â†’ Kubernetes Job
```

#### `hub/store.py` (200ì¤„)
**ì—­í• **: Hubì˜ ì¸ë©”ëª¨ë¦¬ ë°ì´í„° ì €ì¥ì†Œ
**ì €ì¥ ë°ì´í„°**:
- `_appwrappers`: Dict[str, AppWrapper] - Job ID â†’ AppWrapper
- `_clusters`: Dict[str, ClusterInfo] - í´ëŸ¬ìŠ¤í„° ì´ë¦„ â†’ ClusterInfo

**ì£¼ìš” ë©”ì„œë“œ**:
```python
# AppWrapper ê´€ë¦¬
add_appwrapper(appwrapper)           # ì¶”ê°€
get_appwrapper(job_id)               # ì¡°íšŒ
update_appwrapper(job_id, updates)   # ì—…ë°ì´íŠ¸
get_pending_appwrappers()            # ëŒ€ê¸° ì¤‘ ì¡°íšŒ
get_dispatching_ready_appwrappers()  # ë””ìŠ¤íŒ¨ì¹˜ ì¤€ë¹„ë¨ ì¡°íšŒ

# ClusterInfo ê´€ë¦¬
update_cluster_info(cluster_info)    # ë“±ë¡/ì—…ë°ì´íŠ¸
get_cluster_info(name)               # ì¡°íšŒ
get_all_cluster_info()               # ì „ì²´ ì¡°íšŒ

# í†µê³„
get_stats()                          # ì‹œìŠ¤í…œ í†µê³„
```

**íŠ¹ì§•**: asyncio.Lockìœ¼ë¡œ ë™ì‹œì„± ì œì–´

#### `hub/scheduler.py` (280ì¤„)
**ì—­í• **: CASPIAN ìŠ¤ì¼€ì¤„ëŸ¬ - 3ë‹¨ê³„ ìŠ¤ì¼€ì¤„ë§ í”„ë¡œì„¸ìŠ¤
**ì‹¤í–‰ ì£¼ê¸°**: 5ë¶„ë§ˆë‹¤ ìë™ ì‹¤í–‰ (ì„¤ì • ê°€ëŠ¥)

**3ë‹¨ê³„ í”„ë¡œì„¸ìŠ¤**:
```python
async def run_scheduling_cycle():
    # Step 1: Collect - Spoke í´ëŸ¬ìŠ¤í„° ì •ë³´ ìˆ˜ì§‘
    cluster_infos = await _collect_cluster_info()
    # carbon_intensity, resources ìˆ˜ì§‘

    # Step 2: Optimize - CASPIAN ìµœì í™” ì‹¤í–‰
    decisions = await _call_optimizer(appwrappers, cluster_infos)
    # MILP ì†”ë²„ë¡œ ìµœì  ë°°ì¹˜ ê²°ì •

    # Step 3: Update - AppWrapper ì—…ë°ì´íŠ¸
    await _update_appwrappers(decisions)
    # targetCluster ì„¤ì •, gate OPEN
```

**ë³€í™˜ ë¡œì§**:
- Hubì˜ ClusterInfo â†’ Optimizerì˜ ClusterCapacity
- Hubì˜ AppWrapper â†’ Optimizerì˜ JobSpec
- Optimizerì˜ ê²°ê³¼ â†’ AppWrapper ì—…ë°ì´íŠ¸

#### `hub/dispatcher.py` (250ì¤„)
**ì—­í• **: Kubernetes Job ë””ìŠ¤íŒ¨ì²˜
**ì‹¤í–‰ ì£¼ê¸°**: 30ì´ˆë§ˆë‹¤ ìë™ ì‹¤í–‰ (ì„¤ì • ê°€ëŠ¥)

**ë””ìŠ¤íŒ¨ì¹˜ í”„ë¡œì„¸ìŠ¤**:
```python
async def run_dispatch_cycle():
    # 1. gate=OPENì¸ AppWrapper ì°¾ê¸°
    ready_appwrappers = await hub_store.get_dispatching_ready_appwrappers()

    # 2. ê° AppWrapperë¥¼ Kubernetesì— ë°°í¬
    for appwrapper in ready_appwrappers:
        cluster_info = await hub_store.get_cluster_info(target_cluster)

        # 3. Kubernetes Job ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìƒì„±
        job_manifest = _create_job_manifest(appwrapper)

        # 4. kubectl context ì „í™˜ í›„ ë°°í¬
        batch_api = _get_k8s_client(cluster_info.kubeconfig_context)
        batch_api.create_namespaced_job(namespace="default", body=job_manifest)

        # 5. AppWrapper ìƒíƒœ ì—…ë°ì´íŠ¸
        appwrapper.status.dispatched = True
        appwrapper.status.phase = "Running"
```

**íŠ¹ì§•**: kubeconfigì˜ contextë¥¼ ì‚¬ìš©í•˜ì—¬ ë©€í‹° í´ëŸ¬ìŠ¤í„° ì ‘ê·¼

---

### ğŸ“‚ `app/` - ê³µìœ  ì»´í¬ë„ŒíŠ¸

Hubì™€ ë ˆê±°ì‹œ ì‹œìŠ¤í…œ ëª¨ë‘ ì‚¬ìš©í•˜ëŠ” í•µì‹¬ ë¡œì§

#### `app/optimizer.py` (400ì¤„)
**ì—­í• **: CASPIAN MILP ìµœì í™” ì•Œê³ ë¦¬ì¦˜
**í”„ë ˆì„ì›Œí¬**: PuLP (Python Linear Programming)
**ì†”ë²„**: CBC (COIN-OR Branch and Cut)

**ëª©ì  í•¨ìˆ˜**:
```python
minimize: Î£ (carbon_intensity Ã— energy_consumption) + migration_cost
```

**ì œì•½ ì¡°ê±´**:
1. ê° Jobì€ ì •í™•íˆ í•œ ë²ˆë§Œ ìŠ¤ì¼€ì¤„ë§
2. í´ëŸ¬ìŠ¤í„° ë¦¬ì†ŒìŠ¤ ìš©ëŸ‰ ì œí•œ (CPU, ë©”ëª¨ë¦¬)
3. ì‹œê°„ ìœˆë„ìš° ì œì•½ (release_slot, deadline_slot)
4. Affinity ì œì•½ (ì„ í˜¸ í´ëŸ¬ìŠ¤í„°)

**ì…ë ¥/ì¶œë ¥**:
```python
# ì…ë ¥
OptimizeInput(
    jobs: List[JobSpec],
    clusters: List[ClusterCapacity],
    carbon_intensities: List[CarbonPoint],
    time_horizon: int
)

# ì¶œë ¥
OptimizeOutput(
    schedule: List[ScheduleDecision],
    total_carbon_g: float,
    optimal: bool
)
```

#### `app/schemas.py` (150ì¤„)
**ì—­í• **: Pydantic ë°ì´í„° ìŠ¤í‚¤ë§ˆ (íƒ€ì… ê²€ì¦)

**ì£¼ìš” ìŠ¤í‚¤ë§ˆ**:
```python
JobSpec            # Job ëª…ì„¸
ClusterCapacity    # í´ëŸ¬ìŠ¤í„° ìš©ëŸ‰
CarbonPoint        # íƒ„ì†Œ ê°•ë„ ë°ì´í„°
OptimizeInput      # ìµœì í™” ì…ë ¥
OptimizeOutput     # ìµœì í™” ì¶œë ¥
ScheduleDecision   # ìŠ¤ì¼€ì¤„ë§ ê²°ì •
```

#### `app/carbon_client.py` (300ì¤„)
**ì—­í• **: íƒ„ì†Œ ê°•ë„ ë°ì´í„° ìˆ˜ì§‘ í´ë¼ì´ì–¸íŠ¸

**ë°ì´í„° ì†ŒìŠ¤**:
- **ì‹¤ì œ**: ElectricityMap API (í™˜ê²½ë³€ìˆ˜ `USE_MOCK_DATA=false`)
- **Mock**: ëœë¤ ì‹œë®¬ë ˆì´ì…˜ (ê¸°ë³¸ê°’ `USE_MOCK_DATA=true`)

**ê¸°ëŠ¥**:
```python
# ë©€í‹° ì¡´ ëª¨ë‹ˆí„°ë§
start_polling(zones: List[str])  # ["KR", "JP", "CN"]

# 10ì´ˆë§ˆë‹¤ ìë™ ì—…ë°ì´íŠ¸
latest_data: Dict[str, Dict]  # {"KR": {"carbonIntensity": 350, ...}}
```

**Mock ë°ì´í„° ë²”ìœ„**:
- KR: 300-400 gCO2/kWh
- JP: 350-500 gCO2/kWh
- CN: 500-750 gCO2/kWh

#### `app/metrics.py` (95ì¤„)
**ì—­í• **: Prometheus ë©”íŠ¸ë¦­ ì •ì˜

**ë©”íŠ¸ë¦­ ëª©ë¡**:
```python
# íƒ„ì†Œ ê°•ë„
grid_carbon_intensity_gco2_per_kwh{zone}

# AppWrapper í†µê³„
appwrappers_total
appwrappers_pending
appwrappers_running
appwrappers_completed

# í´ëŸ¬ìŠ¤í„° í†µê³„
clusters_total
clusters_ready

# API ìš”ì²­
api_requests_total{endpoint, method, status}
```

---

## ğŸš€ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸

### `start-caspian.sh` (400ì¤„)
**ì—­í• **: ì™„ì „ ìë™ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸
**í”Œë«í¼**: Linux, Mac, Windows Git Bash

**ìë™í™” ë‚´ìš©**:
1. ê¸°ì¡´ í™˜ê²½ ì •ë¦¬ (Docker ì»¨í…Œì´ë„ˆ, Kind í´ëŸ¬ìŠ¤í„°)
2. Spoke í´ëŸ¬ìŠ¤í„° 3ê°œ ìƒì„± (carbon-kr, carbon-jp, carbon-cn)
3. Dockerìš© kubeconfig ìƒì„± ë° API ì£¼ì†Œ ë³€í™˜
4. Docker Compose ì„œë¹„ìŠ¤ ì‹œì‘ (Hub, Prometheus, Grafana)
5. Hub API ì¤€ë¹„ ëŒ€ê¸° (ìµœëŒ€ 60ì´ˆ)
6. Spoke í´ëŸ¬ìŠ¤í„° ìë™ ë“±ë¡
7. ì‹œìŠ¤í…œ ìƒíƒœ í™•ì¸ ë° ì¶œë ¥

**ì˜ˆìœ ì¶œë ¥**:
- ìƒ‰ìƒ ì½”ë”© (GREEN, BLUE, YELLOW, RED)
- í”„ë¡œê·¸ë ˆìŠ¤ ë°”
- ë‹¨ê³„ë³„ ì§„í–‰ ìƒí™©

**ì‚¬ìš©ë²•**:
```bash
bash start-caspian.sh
```

### `stop-caspian.sh` (70ì¤„)
**ì—­í• **: ì‹œìŠ¤í…œ ì¢…ë£Œ ìŠ¤í¬ë¦½íŠ¸

**ê¸°ëŠ¥**:
1. Docker ì»¨í…Œì´ë„ˆ ì¢…ë£Œ
2. Kind í´ëŸ¬ìŠ¤í„° ì‚­ì œ ì˜µì…˜ ì œê³µ (ì‚¬ìš©ì ì„ íƒ)

### `setup-spoke-clusters.sh` (150ì¤„)
**ì—­í• **: Kind í´ëŸ¬ìŠ¤í„° ìƒì„± ìŠ¤í¬ë¦½íŠ¸

**ìƒì„± í´ëŸ¬ìŠ¤í„°**:
- carbon-kr: 1 control-plane + 2 workers
- carbon-jp: 1 control-plane + 2 workers
- carbon-cn: 1 control-plane + 2 workers

---

## ğŸ³ Docker ê´€ë ¨

### `docker-compose.yml`
**ì„œë¹„ìŠ¤ êµ¬ì„±**:
```yaml
services:
  hub:            # Hub Cluster API (í¬íŠ¸ 8080)
  prometheus:     # ë©”íŠ¸ë¦­ ìˆ˜ì§‘ (í¬íŠ¸ 9090)
  grafana:        # ëŒ€ì‹œë³´ë“œ (í¬íŠ¸ 3000)

networks:
  carbon-network: # ì„œë¹„ìŠ¤ ê°„ í†µì‹ 
  kind:           # Kind í´ëŸ¬ìŠ¤í„° ì—°ê²° (external)
```

**Hub í™˜ê²½ë³€ìˆ˜**:
- `ELECTRICITYMAP_API_KEY`: ElectricityMap API í‚¤
- `CARBON_ZONES`: ëª¨ë‹ˆí„°ë§í•  ì§€ì—­ (KR,JP,CN)
- `USE_MOCK_DATA`: Mock ë°ì´í„° ì‚¬ìš© ì—¬ë¶€ (true/false)
- `KUBECONFIG`: kubeconfig íŒŒì¼ ê²½ë¡œ
- `SCHEDULER_INTERVAL`: ìŠ¤ì¼€ì¤„ëŸ¬ ì‹¤í–‰ ì£¼ê¸° (ì´ˆ)
- `DISPATCHER_INTERVAL`: ë””ìŠ¤íŒ¨ì²˜ ì‹¤í–‰ ì£¼ê¸° (ì´ˆ)

### `Dockerfile`
**ë² ì´ìŠ¤ ì´ë¯¸ì§€**: python:3.11-slim

**ë¹Œë“œ ë‚´ìš©**:
1. app/requirements.txt ì„¤ì¹˜
2. app/ ë””ë ‰í† ë¦¬ ë³µì‚¬
3. hub/ ë””ë ‰í† ë¦¬ ë³µì‚¬
4. .kube ë””ë ‰í† ë¦¬ ìƒì„±

### `prometheus.yml`
**ìŠ¤í¬ë ˆì´í”„ ì„¤ì •**:
```yaml
scrape_configs:
  - job_name: 'hub-cluster'
    static_configs:
      - targets: ['hub:8080']
    metrics_path: '/metrics'
    scrape_interval: 10s
```

---

## ğŸ“Š Grafana ê´€ë ¨

### `dashboards/carbon-hub-dashboard.json`
**í˜„ì¬ ì‚¬ìš© ì¤‘ì¸ ëŒ€ì‹œë³´ë“œ**

**íŒ¨ë„ êµ¬ì„±** (10ê°œ):
1. Korea Carbon Intensity (Gauge)
2. Japan Carbon Intensity (Gauge)
3. China Carbon Intensity (Gauge)
4. Carbon Intensity Over Time (Time Series)
5. Total AppWrappers (Stat)
6. Pending AppWrappers (Stat)
7. Running AppWrappers (Stat)
8. Completed AppWrappers (Stat)
9. Total Clusters (Stat)
10. Ready Clusters (Stat)

**ìë™ ë¦¬í”„ë ˆì‹œ**: 5ì´ˆ

### `grafana/provisioning/datasources/prometheus.yml`
**Prometheus ë°ì´í„°ì†ŒìŠ¤ ìë™ ì„¤ì •**:
```yaml
datasources:
  - name: Prometheus
    type: prometheus
    url: http://prometheus:9090
    isDefault: true
```

### `grafana/provisioning/dashboards/dashboard.yml`
**ëŒ€ì‹œë³´ë“œ ìë™ í”„ë¡œë¹„ì €ë‹**:
```yaml
providers:
  - name: 'Carbon Aware Dashboards'
    folder: ''
    type: file
    options:
      path: /etc/grafana/provisioning/dashboards/files
```

---

## ğŸ“– ë¬¸ì„œ íŒŒì¼

### í•„ìˆ˜ ë¬¸ì„œ (ì½ê¸° ìˆœì„œ)

1. **`QUICKSTART.md`** (1ë¶„)
   - ì´ˆê°„ë‹¨ ì‹œì‘ ê°€ì´ë“œ
   - í•œ í˜ì´ì§€ì— ëª¨ë“  ê²ƒ

2. **`README.md`** (5ë¶„)
   - í”„ë¡œì íŠ¸ ê°œìš”
   - ë¹ ë¥¸ ì‹œì‘
   - ì‚¬ìš© ì˜ˆì‹œ
   - ì „ì²´ ì°¸ì¡°

3. **`ì‹œë™_ê°€ì´ë“œ.md`** (í•„ìš”ì‹œ)
   - ìƒì„¸ ì‹œì‘ ë°©ë²•
   - ìˆ˜ë™ ì‹œì‘ ë°©ë²•
   - íŠ¸ëŸ¬ë¸”ìŠˆíŒ…
   - ë¡œê·¸ í™•ì¸

### ì°¸ê³  ë¬¸ì„œ

4. **`ì‹œìŠ¤í…œ_ì™„ë£Œ_ë³´ê³ ì„œ.md`**
   - êµ¬í˜„ ì™„ë£Œ ë‚´ìš©
   - í˜„ì¬ ì‹œìŠ¤í…œ ìƒíƒœ
   - í…ŒìŠ¤íŠ¸ ê²°ê³¼
   - ë©”íŠ¸ë¦­ ì •ë³´

5. **`HUB_SPOKE_êµ¬í˜„_ê°€ì´ë“œ.md`**
   - Hub-Spoke ì•„í‚¤í…ì²˜ ìƒì„¸
   - êµ¬í˜„ ë‚´ìš©
   - API ë¬¸ì„œ

6. **`CASPIAN_ì•Œê³ ë¦¬ì¦˜_ì„¤ëª….md`**
   - MILP ìµœì í™” ì•Œê³ ë¦¬ì¦˜
   - ìˆ˜í•™ì  ëª¨ë¸
   - ì œì•½ ì¡°ê±´

7. **`ë§ˆì´ê·¸ë ˆì´ì…˜_ê°€ì´ë“œ.md`**
   - ë ˆê±°ì‹œì—ì„œ Hub-Spokeë¡œ ì „í™˜
   - íŒŒì¼ ì •ë¦¬ ê°€ì´ë“œ

8. **`scheduling_sample.md`**
   - ì›ë³¸ ìŠ¤ì¼€ì¤„ë§ ìƒ˜í”Œ (ì°¸ê³ ìš©)

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ íŒŒì¼

### `test_caspian.py`
**ì—­í• **: í†µí•© í…ŒìŠ¤íŠ¸
**í…ŒìŠ¤íŠ¸ í•­ëª©**:
- CASPIAN ìµœì í™” ì•Œê³ ë¦¬ì¦˜
- ë©€í‹° í´ëŸ¬ìŠ¤í„° ìŠ¤ì¼€ì¤„ë§
- íƒ„ì†Œ ê°•ë„ ê¸°ë°˜ ë°°ì¹˜

### `test-job-*.yaml`
**ì—­í• **: Kubernetes Job í…ŒìŠ¤íŠ¸ ë§¤ë‹ˆí˜ìŠ¤íŠ¸
- `test-job-kr.yaml`: í•œêµ­ í´ëŸ¬ìŠ¤í„°ìš©
- `test-job-jp.yaml`: ì¼ë³¸ í´ëŸ¬ìŠ¤í„°ìš©
- `test-job-cn.yaml`: ì¤‘êµ­ í´ëŸ¬ìŠ¤í„°ìš©

---

## ğŸ—‘ï¸ ë ˆê±°ì‹œ íŒŒì¼ (ì‚¬ìš©í•˜ì§€ ì•ŠìŒ)

### ì‚­ì œëœ íŒŒì¼
- ~~`app/main.py`~~ â†’ `hub/app.py`ë¡œ ëŒ€ì²´
- ~~`app/job_store.py`~~ â†’ `hub/store.py`ë¡œ ëŒ€ì²´
- ~~`app/k8s_client.py`~~ â†’ `hub/dispatcher.py`ë¡œ ëŒ€ì²´
- ~~`app/dispatcher.py`~~ â†’ `hub/dispatcher.py`ë¡œ ëŒ€ì²´

### ë³´ê´€ëœ ë ˆê±°ì‹œ
- `dev-run.sh`: ê°œë°œ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ì‚¬ìš© ì•ˆ í•¨)
- `run_local.sh`: ë¡œì»¬ ì‹¤í–‰ ìŠ¤í¬ë¦½íŠ¸ (ì‚¬ìš© ì•ˆ í•¨)
- `start-hub-spoke.sh`: êµ¬ë²„ì „ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ (ì‚¬ìš© ì•ˆ í•¨)
- `start-system.bat`: êµ¬ë²„ì „ Windows ìŠ¤í¬ë¦½íŠ¸ (ì‚¬ìš© ì•ˆ í•¨)
- `dashboards/carbon_dashboard.json`: êµ¬ë²„ì „ ëŒ€ì‹œë³´ë“œ (ì‚¬ìš© ì•ˆ í•¨)

**ê¶Œì¥**: ë ˆê±°ì‹œ íŒŒì¼ì€ ì‚­ì œí•´ë„ ë¬´ë°©

### `operator/` ë””ë ‰í† ë¦¬
**ìƒíƒœ**: ë¯¸êµ¬í˜„ / ë¯¸ì‚¬ìš©
**ë‚´ìš©**: Kubernetes Operator êµ¬í˜„ (í–¥í›„ ê³„íš)

### `k8s/` ë””ë ‰í† ë¦¬
**ìƒíƒœ**: ì°¸ê³ ìš©
**ë‚´ìš©**: Kubernetes ë°°í¬ ë§¤ë‹ˆí˜ìŠ¤íŠ¸ (í˜„ì¬ëŠ” Hubê°€ ë™ì  ìƒì„±)

---

## ğŸ”‘ í•µì‹¬ íŒŒì¼ ìš”ì•½

### ë°˜ë“œì‹œ ìœ ì§€í•´ì•¼ í•  íŒŒì¼

| íŒŒì¼ | ì—­í•  | ì¤‘ìš”ë„ |
|------|------|--------|
| `hub/app.py` | Hub API ì„œë²„ | â­â­â­â­â­ |
| `hub/scheduler.py` | CASPIAN ìŠ¤ì¼€ì¤„ëŸ¬ | â­â­â­â­â­ |
| `hub/dispatcher.py` | Kubernetes ë””ìŠ¤íŒ¨ì²˜ | â­â­â­â­â­ |
| `hub/store.py` | ë°ì´í„° ì €ì¥ì†Œ | â­â­â­â­â­ |
| `hub/models.py` | ë°ì´í„° ëª¨ë¸ | â­â­â­â­â­ |
| `app/optimizer.py` | MILP ìµœì í™” | â­â­â­â­â­ |
| `app/carbon_client.py` | íƒ„ì†Œ ë°ì´í„° ìˆ˜ì§‘ | â­â­â­â­â­ |
| `app/metrics.py` | Prometheus ë©”íŠ¸ë¦­ | â­â­â­â­ |
| `app/schemas.py` | ë°ì´í„° ìŠ¤í‚¤ë§ˆ | â­â­â­â­ |
| `start-caspian.sh` | ìë™ ì‹œì‘ ìŠ¤í¬ë¦½íŠ¸ | â­â­â­â­â­ |
| `docker-compose.yml` | Docker ì„¤ì • | â­â­â­â­â­ |
| `Dockerfile` | ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ | â­â­â­â­ |
| `prometheus.yml` | Prometheus ì„¤ì • | â­â­â­ |
| `dashboards/carbon-hub-dashboard.json` | Grafana ëŒ€ì‹œë³´ë“œ | â­â­â­â­ |

---

## ğŸ“Š íŒŒì¼ í†µê³„

```
ì´ íŒŒì¼ ìˆ˜: ~60ê°œ
Python ì½”ë“œ: ~15ê°œ (hub/ + app/)
ë¬¸ì„œ: ~10ê°œ (.md)
ì„¤ì •: ~10ê°œ (.yml, .yaml, .json)
ìŠ¤í¬ë¦½íŠ¸: ~8ê°œ (.sh, .bat)
í…ŒìŠ¤íŠ¸: ~5ê°œ
```

**ì½”ë“œ ë¼ì¸ ìˆ˜**:
- hub/: ~1,365 ì¤„
- app/: ~1,150 ì¤„
- ìŠ¤í¬ë¦½íŠ¸: ~600 ì¤„
- **ì´**: ~3,000 ì¤„

---

## ğŸ¯ ë””ë ‰í† ë¦¬ë³„ ìš©ë„

| ë””ë ‰í† ë¦¬ | ìš©ë„ | ìƒíƒœ |
|----------|------|------|
| `hub/` | Hub Cluster êµ¬í˜„ | âœ… ì‚¬ìš© ì¤‘ |
| `app/` | ê³µìœ  ì»´í¬ë„ŒíŠ¸ | âœ… ì‚¬ìš© ì¤‘ |
| `dashboards/` | Grafana ëŒ€ì‹œë³´ë“œ | âœ… ì‚¬ìš© ì¤‘ |
| `grafana/` | Grafana í”„ë¡œë¹„ì €ë‹ | âœ… ì‚¬ìš© ì¤‘ |
| `clusters/` | Kind í´ëŸ¬ìŠ¤í„° ì„¤ì • | âœ… ì‚¬ìš© ì¤‘ |
| `k8s/` | K8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ | ğŸ“‚ ì°¸ê³ ìš© |
| `operator/` | K8s Operator | âŒ ë¯¸ì‚¬ìš© |

---

## ğŸ”„ ë°ì´í„° íë¦„

```
1. ì‚¬ìš©ì â†’ Hub API (POST /hub/appwrappers)
   â†“
2. HubStoreì— AppWrapper ì €ì¥ (phase: Pending)
   â†“
3. HubScheduler (5ë¶„ë§ˆë‹¤)
   - ClusterInfo ìˆ˜ì§‘ (carbon_intensity, resources)
   - CASPIAN Optimizer í˜¸ì¶œ (MILP)
   - AppWrapper ì—…ë°ì´íŠ¸ (targetCluster, gate=OPEN)
   â†“
4. HubDispatcher (30ì´ˆë§ˆë‹¤)
   - gate=OPENì¸ AppWrapper ì°¾ê¸°
   - Kubernetes Job ìƒì„±
   - Spoke í´ëŸ¬ìŠ¤í„°ì— ë°°í¬
   - AppWrapper ìƒíƒœ ì—…ë°ì´íŠ¸ (phase: Running)
   â†“
5. Prometheus
   - Hub /metrics ìˆ˜ì§‘ (10ì´ˆë§ˆë‹¤)
   â†“
6. Grafana
   - Prometheus ë°ì´í„° ì‹œê°í™” (5ì´ˆë§ˆë‹¤ ê°±ì‹ )
```

---

## ğŸš€ ì‹¤í–‰ í”„ë¡œì„¸ìŠ¤

### ì‹œì‘ ì‹œ
```bash
bash start-caspian.sh
  â†“
1. Docker ì»¨í…Œì´ë„ˆ ì •ë¦¬
2. Kind í´ëŸ¬ìŠ¤í„° ìƒì„± (carbon-kr, carbon-jp, carbon-cn)
3. kubeconfig ìƒì„± ë° ë³€í™˜
4. Docker Compose ì‹œì‘ (hub, prometheus, grafana)
5. Hub API ëŒ€ê¸°
6. ClusterInfo ë“±ë¡
  â†“
ì‹œìŠ¤í…œ ì¤€ë¹„ ì™„ë£Œ!
```

### ëŸ°íƒ€ì„
```
Hub API (8080) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
  â†“ (5ë¶„ë§ˆë‹¤)           â”‚
HubScheduler            â”‚
  â†“                     â”‚
CASPIAN Optimizer       â”‚
  â†“                     â”‚
AppWrapper ì—…ë°ì´íŠ¸      â”‚
  â†“ (30ì´ˆë§ˆë‹¤)          â”‚
HubDispatcher           â”‚
  â†“                     â”‚
Kubernetes Job ë°°í¬ â”€â”€â”€â”€â”˜
  â†“
Spoke Clusters (KR, JP, CN)
```

---

## ğŸ’¡ íŒŒì¼ ì°¾ê¸° íŒ

### Hub ê´€ë ¨
- API ì—”ë“œí¬ì¸íŠ¸: `hub/app.py`
- ìŠ¤ì¼€ì¤„ë§ ë¡œì§: `hub/scheduler.py`
- Job ë°°í¬: `hub/dispatcher.py`
- ë°ì´í„° ëª¨ë¸: `hub/models.py`

### ìµœì í™” ê´€ë ¨
- MILP ì•Œê³ ë¦¬ì¦˜: `app/optimizer.py`
- ìŠ¤í‚¤ë§ˆ: `app/schemas.py`

### ëª¨ë‹ˆí„°ë§ ê´€ë ¨
- íƒ„ì†Œ ë°ì´í„°: `app/carbon_client.py`
- ë©”íŠ¸ë¦­: `app/metrics.py`
- Grafana ëŒ€ì‹œë³´ë“œ: `dashboards/carbon-hub-dashboard.json`

### ì„¤ì • ê´€ë ¨
- Docker: `docker-compose.yml`, `Dockerfile`
- Prometheus: `prometheus.yml`
- Grafana: `grafana/provisioning/`

### ì‹œì‘ ê´€ë ¨
- ìë™ ì‹œì‘: `start-caspian.sh`
- í´ëŸ¬ìŠ¤í„° ìƒì„±: `setup-spoke-clusters.sh`
- ì¢…ë£Œ: `stop-caspian.sh`

---

ì´ ë¬¸ì„œëŠ” í”„ë¡œì íŠ¸ì˜ ëª¨ë“  íŒŒì¼ê³¼ ë””ë ‰í† ë¦¬ì˜ ì—­í• ì„ ì„¤ëª…í•©ë‹ˆë‹¤.

**ë¹ ë¥¸ ì°¸ì¡°**:
- ì‹œì‘: `bash start-caspian.sh`
- ë¬¸ì„œ: `README.md` â†’ `QUICKSTART.md` â†’ `ì‹œë™_ê°€ì´ë“œ.md`
