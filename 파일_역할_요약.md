# 파일 역할 요약 (핵심만)

## 🎯 가장 중요한 5개 파일

### 1. `start-caspian.sh` ⭐⭐⭐⭐⭐
**한 줄 요약**: 전체 시스템을 자동으로 시작하는 스크립트

**실행**:
```bash
bash start-caspian.sh
```

**기능**:
- Spoke 클러스터 3개 생성
- Hub + Prometheus + Grafana 시작
- 클러스터 자동 등록
- 2-3분이면 모든 준비 완료

---

### 2. `hub/app.py` ⭐⭐⭐⭐⭐
**한 줄 요약**: Hub Cluster의 메인 API 서버

**포트**: 8080

**핵심 API**:
```bash
POST /hub/appwrappers   # Job 제출
POST /hub/schedule      # 스케줄링
POST /hub/dispatch      # 배포
GET  /hub/stats         # 상태 확인
GET  /metrics           # Prometheus 메트릭
```

---

### 3. `hub/scheduler.py` ⭐⭐⭐⭐⭐
**한 줄 요약**: CASPIAN 스케줄러 - 탄소 최적화 실행

**실행 주기**: 5분마다 자동

**3단계 프로세스**:
```
1. Collect  → 클러스터 정보 수집 (탄소 강도, 리소스)
2. Optimize → MILP 최적화 (최소 탄소 배출)
3. Update   → targetCluster 설정, gate OPEN
```

---

### 4. `hub/dispatcher.py` ⭐⭐⭐⭐⭐
**한 줄 요약**: Kubernetes Job 배포 담당

**실행 주기**: 30초마다 자동

**동작**:
```
1. gate=OPEN인 AppWrapper 찾기
2. Kubernetes Job 생성
3. Spoke 클러스터에 배포
4. 상태 업데이트 (Running)
```

---

### 5. `app/optimizer.py` ⭐⭐⭐⭐⭐
**한 줄 요약**: CASPIAN MILP 최적화 알고리즘

**목적**: 탄소 배출 최소화

**수식**:
```
minimize: Σ (carbon_intensity × energy)

제약:
- 각 Job은 1번만 스케줄링
- 리소스 용량 제한
- 시간 윈도우 제약
```

---

## 📂 디렉토리별 역할

### `hub/` - Hub Cluster (핵심)
```
hub/app.py        # API 서버 (8080)
hub/scheduler.py  # 스케줄러 (5분)
hub/dispatcher.py # 디스패처 (30초)
hub/store.py      # 데이터 저장
hub/models.py     # 데이터 모델
```

**역할**: 중앙 허브 - 모든 제어 로직

---

### `app/` - 공유 컴포넌트
```
app/optimizer.py      # MILP 최적화 ⭐
app/carbon_client.py  # 탄소 데이터 수집 (10초)
app/metrics.py        # Prometheus 메트릭
app/schemas.py        # 데이터 스키마
```

**역할**: Hub와 공유하는 핵심 로직

---

### `dashboards/` - Grafana
```
carbon-hub-dashboard.json  # CASPIAN 대시보드
```

**패널**: 탄소 강도, AppWrapper 통계, 클러스터 상태

---

### `grafana/provisioning/` - 자동 설정
```
datasources/prometheus.yml  # Prometheus 연결
dashboards/dashboard.yml    # 대시보드 로딩
```

**역할**: Grafana 시작 시 자동 설정

---

## 🚀 시작 파일

### `start-caspian.sh` (자동)
**사용**: `bash start-caspian.sh`

**내용**: 전체 자동화

---

### `docker-compose.yml`
**서비스**:
- hub (8080)
- prometheus (9090)
- grafana (3000)

---

### `Dockerfile`
**역할**: Hub 컨테이너 이미지 빌드

**포함**: Python 3.11 + hub/ + app/

---

## 📖 문서 파일

### 읽기 순서
1. **QUICKSTART.md** (1분) - 빠른 시작
2. **README.md** (5분) - 전체 개요
3. **시동_가이드.md** (필요시) - 상세 가이드
4. **프로젝트_구조.md** - 전체 파일 설명 ← 지금 여기

### 참고 문서
- **시스템_완료_보고서.md** - 현재 상태
- **HUB_SPOKE_구현_가이드.md** - 구현 상세
- **CASPIAN_알고리즘_설명.md** - 알고리즘

---

## 🔄 실행 흐름

```
사용자
  ↓ bash start-caspian.sh
자동 시작 (2-3분)
  ↓
Hub API (8080) 준비
  ↓ POST /hub/appwrappers
AppWrapper 제출
  ↓ 5분 후
Scheduler → CASPIAN 최적화 → targetCluster 결정
  ↓ 30초 후
Dispatcher → Kubernetes Job 배포
  ↓
Spoke Cluster에서 Job 실행
```

---

## 💾 데이터 저장

### `hub/store.py` (인메모리)
```python
_appwrappers: Dict[str, AppWrapper]  # Job 목록
_clusters: Dict[str, ClusterInfo]    # 클러스터 목록
```

**특징**: 메모리에만 저장 (재시작 시 초기화)

---

## 📊 모니터링

### Prometheus (`prometheus.yml`)
```yaml
scrape_configs:
  - job_name: 'hub-cluster'
    targets: ['hub:8080']
    metrics_path: '/metrics'
```

**수집**: 10초마다 Hub /metrics 스크랩

---

### Grafana (3000)
- **ID/PW**: admin/admin
- **대시보드**: "CASPIAN Carbon-Aware Scheduling"
- **갱신**: 5초마다

---

## 🧪 테스트

### `test_caspian.py`
**역할**: 통합 테스트

**실행**:
```bash
python test_caspian.py
```

---

### `test-job-*.yaml`
**역할**: Kubernetes Job 매니페스트

**클러스터별**:
- test-job-kr.yaml → carbon-kr
- test-job-jp.yaml → carbon-jp
- test-job-cn.yaml → carbon-cn

---

## 🗑️ 삭제해도 되는 파일

### 레거시 (사용 안 함)
```
dev-run.sh
run_local.sh
start-hub-spoke.sh
start-system.bat
dashboards/carbon_dashboard.json
```

### 미사용 디렉토리
```
operator/    # K8s Operator (미구현)
k8s/         # 매니페스트 (참고용)
```

---

## ⚙️ 설정 파일

### `docker-compose.yml`
**환경변수**:
```yaml
ELECTRICITYMAP_API_KEY: ebGFEg4L68pWwe68DdVu
CARBON_ZONES: KR,JP,CN
USE_MOCK_DATA: true
SCHEDULER_INTERVAL: 300  # 5분
DISPATCHER_INTERVAL: 30  # 30초
```

---

### `prometheus.yml`
**타겟**: hub:8080

---

### `kubeconfig-docker` (생성됨)
**역할**: Docker 컨테이너용 kubeconfig

**변환**:
```
localhost:56861 → carbon-kr-control-plane:6443
```

---

## 📍 핵심 포인트

### 시스템 시작
```bash
bash start-caspian.sh
```

### 상태 확인
```bash
curl http://localhost:8080/hub/stats
```

### Job 제출
```bash
curl -X POST http://localhost:8080/hub/appwrappers \
  -H "Content-Type: application/json" \
  -d '{"job_id":"test","cpu":2.0,"mem_gb":4.0,"runtime_minutes":30,"deadline_minutes":120}'
```

### 대시보드
http://localhost:3000 (admin/admin)

---

## 🎯 기억해야 할 3가지

1. **시작**: `bash start-caspian.sh`
2. **Hub API**: http://localhost:8080
3. **Grafana**: http://localhost:3000

**그게 전부!** 🚀

---

**상세 정보**: [프로젝트_구조.md](프로젝트_구조.md) 참조
